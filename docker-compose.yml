services:
  cloudsql-proxy:
    container_name: cloudsql-proxy
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.7
    user: root
    command: >
      --credentials-file=/secrets/cloudsql/cloud-sql-proxy-service-account.json
      --unix-socket=/socket
      --max-connections 100
      --max-sigterm-delay 30s
      som-rit-phi-redcap-prod:us-west1:redcap-rag
    volumes:
      - ./secrets:/secrets/cloudsql
      - socket_volume:/socket
    restart: always
  scraper:
    build: .
    container_name: rag_pipeline
    depends_on:
      - cloudsql-proxy
    ports:
      - "9090:8080"
    volumes:
      - ./:/app          # full source mapped for reload
      - ./cache:/app/cache
      - ./config:/app/config
      - socket_volume:/socket
    env_file:
      - .env
    environment:
      - DB_SOCKET_DIR=/socket
      - CLOUD_SQL_CONNECTION_NAME=som-rit-phi-redcap-prod:us-west1:redcap-rag
    stdin_open: true
    tty: true
    command: uvicorn rag_pipeline.web:app --host 0.0.0.0 --port 8080 --reload --timeout-keep-alive 7200

volumes:
  socket_volume:
